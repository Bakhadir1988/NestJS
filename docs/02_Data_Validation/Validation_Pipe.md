
# 02_Data_Validation: ValidationPipe

## 1. Краткое описание темы

`ValidationPipe` — это встроенный в NestJS "пайп" (pipe), который использует библиотеки `class-validator` и `class-transformer` для автоматической проверки и преобразования входящих данных клиентских запросов.

Основная задача — убедиться, что `body`, `query` или `params` запроса соответствуют правилам, определенным в DTO (Data Transfer Object). Если данные невалидны, пайп автоматически выбрасывает исключение `BadRequestException`, возвращая клиенту ошибку 400 с подробным описанием проблемы.

## 2. Ключевые концепции

#### Как это работает?
Когда вы применяете `ValidationPipe`, он перехватывает входящие данные, предназначенные для обработчика роута. Если в методе контроллера указан DTO (например, `@Body() createHabitDto: CreateHabitDto`), пайп делает следующее:
1.  Проверяет, есть ли на свойствах класса `CreateHabitDto` декораторы из `class-validator` (например, `@IsString()`, `@IsNotEmpty()`).
2.  Применяет эти правила к входящим данным.
3.  Если есть ошибки — прерывает выполнение и отправляет клиенту ответ 400.
4.  Если все в порядке — пропускает данные дальше.

#### Глобальное применение
Самый распространенный и рекомендуемый способ — применить `ValidationPipe` глобально ко всему приложению. Это гарантирует, что *все* эндпоинты будут защищены едиными правилами валидации. Это делается в `main.ts`.

#### Ключевые опции
`ValidationPipe` можно (и нужно) настраивать. Три самые важные опции:

1.  `whitelist: true`
    **Что делает:** Автоматически удаляет из объекта DTO любые свойства, которые не описаны в его классе.
    **Зачем нужно:** Защищает от "загрязнения" данных. Если клиент пришлет в `body` лишние поля (`{ "name": "...", "isAdmin": true }`), `ValidationPipe` незаметно удалит `isAdmin`, и до вашего сервиса дойдет только `name`.

2.  `forbidNonWhitelisted: true`
    **Что делает:** Работает в паре с `whitelist`. Если `true`, то при наличии лишних свойств пайп не просто удалит их, а **выбросит ошибку**.
    **Зачем нужно:** Это более строгий подход. Он немедленно информирует клиента, что тот присылает некорректные данные. Это помогает быстрее выявлять ошибки на стороне фронтенда.

3.  `transform: true`
    **Что делает:** Автоматически преобразует входящие JSON-объекты в экземпляры вашего класса DTO. Также пытается преобразовать примитивные типы (например, строковый `id` из URL в `number`).
    **Зачем нужно:** Это очень мощная опция. Без нее вы получаете просто `Object`, а с ней — `instanceof CreateHabitDto`. Это позволяет использовать методы класса, значения по умолчанию и другие возможности классов TypeScript.

## 3. Пример кода

Вот как настроить `ValidationPipe` глобально с рекомендуемыми опциями в вашем `main.ts`.

```typescript
// src/main.ts
import 'dotenv/config';
import { NestFactory } from '@nestjs/core';
import { ValidationPipe } from '@nestjs/common'; // 1. Импортируем
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  app.setGlobalPrefix('api');

  // 2. Применяем глобальный пайп с настройками
  app.useGlobalPipes(
    new ValidationPipe({
      whitelist: true,
      forbidNonWhitelisted: true,
      transform: true,
    }),
  );

  // ... (остальной код, например, enableShutdownHooks)
  await app.listen(process.env.PORT ?? 3000);
}
bootstrap();
```

## 4. Частые ошибки

- **Забыть применить пайп:** Самая частая ошибка. Декораторы в DTO добавлены, но `app.useGlobalPipes` в `main.ts` не вызван. В итоге валидация не работает.
- **Не использовать `transform: true`:** Пытаться вызвать метод DTO (`dto.someMethod()`) и получать ошибку, потому что `dto` на самом деле является простым объектом, а не экземпляром класса.
- **Путаница `whitelist` и `forbidNonWhitelisted`:** Не понимать, что `whitelist` молча удаляет поля, а `forbidNonWhitelisted` активно сообщает об ошибке.

## 5. Best Practices

- **Всегда используйте `ValidationPipe` глобально.** Это обеспечивает консистентность и безопасность по умолчанию.
- **Всегда используйте опции `whitelist`, `forbidNonWhitelisted` и `transform`.** Этот набор настроек предоставляет наилучший баланс безопасности, строгости и удобства.

## 6. Краткий вывод

`ValidationPipe` — это декларативный и мощный способ обезопасить ваше API на уровне входных данных. Он избавляет от необходимости писать рутинный код проверки в каждом методе контроллера и является неотъемлемой частью любого production-ready NestJS приложения.

## 7. Практическое задание

1.  Откройте ваш файл `src/main.ts`.
2.  Импортируйте `ValidationPipe` из `@nestjs/common`.
3.  Добавьте строку `app.useGlobalPipes(...)` с опциями, как показано в примере выше.
4.  **Протестируйте:**
    - Запустите приложение.
    - С помощью Postman, Insomnia или другой подобной программы отправьте `POST` запрос на `/api/habits` со следующим `body`:
      ```json
      {
        "name": "Изучать NestJS",
        "description": "Каждый день по 1 часу",
        "completed": false,
        "unexpected_property": "some_value" 
      }
      ```
    - Вы должны получить ошибку **400 Bad Request** с сообщением, что свойство `unexpected_property` не разрешено. Это будет означать, что `forbidNonWhitelisted: true` работает.
